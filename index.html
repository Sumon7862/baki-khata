<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Baki Khata Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:system-ui,Arial}
body{background:#eef2f7;padding:10px}
.container{max-width:480px;margin:auto;background:#fff;padding:10px;border-radius:12px}
h1,h2,h3{text-align:center;font-size:16px}
input,select,button{width:100%;padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc;font-size:14px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
.back-btn{background:#6b7280;margin-bottom:6px}
.customer-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #ddd;cursor:pointer}
.customer-row:hover{background:#f1f5f9}
.del-customer{color:#dc3545;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:6px;font-size:12px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#f3f4f6}
.tx-btn{cursor:pointer}
.edit{color:#2563eb}
.delete{color:#dc3545}
.baki{color:red;font-weight:bold}
.payment{color:green;font-weight:bold}
</style>
</head>

<body>
<div class="container">

<!-- PAGE 1 -->
<div id="page-list">
<h1>üìí Baki Khata</h1>

<form id="addCustomerForm">
<input id="customerName" placeholder="Customer name" required>
<button>Add Customer</button>
</form>

<div id="customerList"></div>
<h3 id="grandTotal">Total Due: 0 Taka</h3>
</div>

<!-- PAGE 2 -->
<div id="page-detail" style="display:none">
<button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
<h2 id="detailName"></h2>
<h3 id="detailBalance"></h3>

<form id="detailForm">
<input type="number" id="amount" placeholder="Amount" required>
<select id="type">
<option value="baki">Due</option>
<option value="payment">Payment</option>
</select>
<input id="note" placeholder="Note">
<button>Add</button>
</form>

<table>
<thead>
<tr>
<th>Date</th>
<th>Type</th>
<th>Amount</th>
<th>Note</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, deleteDoc, updateDoc,
  onSnapshot, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ===== Firebase ===== */
const firebaseConfig={
  apiKey:"AIzaSyDO5I_osPflsq1MrPOY7YJ46iDNJKWlQWE",
  authDomain:"baki-khata-e0941.firebaseapp.com",
  projectId:"baki-khata-e0941"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* ===== DOM ===== */
const customerList=document.getElementById("customerList");
const pageList=document.getElementById("page-list");
const pageDetail=document.getElementById("page-detail");
const detailName=document.getElementById("detailName");
const detailBalance=document.getElementById("detailBalance");
const history=document.getElementById("history");
const grandTotalEl=document.getElementById("grandTotal");

let currentCustomerId=null;
let editingTxId=null;
let unsubTx=null;

/* ===== Utils ===== */
const formatDate=()=>{
  const d=new Date();
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`
};

/* ================= PAGE 1 REALTIME ================= */
onSnapshot(collection(db,"customers"),snap=>{
  customerList.innerHTML="";
  let total=0,i=1;

  snap.forEach(d=>{
    const c=d.data();
    total+=c.balance||0;

    const row=document.createElement("div");
    row.className="customer-row";
    row.innerHTML=`
      <span style="flex:1">${i++}. ${c.name} - ${c.balance||0} Tk</span>
      <span class="del-customer">üóëÔ∏è</span>
    `;

    row.onclick=()=>openCustomer(d.id,c.name);
    row.querySelector(".del-customer").onclick=async e=>{
      e.stopPropagation();
      if(confirm("Delete customer?")){
        await deleteDoc(doc(db,"customers",d.id));
      }
    };

    customerList.appendChild(row);
  });

  grandTotalEl.innerText=`Total Due: ${total} Taka`;
});

/* ================= ADD CUSTOMER ================= */
addCustomerForm.onsubmit=async e=>{
  e.preventDefault();
  await addDoc(collection(db,"customers"),{
    name:customerName.value.trim(),
    balance:0,
    createdAt:serverTimestamp()
  });
  addCustomerForm.reset();
};

/* ================= OPEN CUSTOMER ================= */
function openCustomer(id,name){
  currentCustomerId=id;
  detailName.innerText=name;
  pageList.style.display="none";
  pageDetail.style.display="block";
  listenTransactions();
}

/* ================= TRANSACTIONS REALTIME ================= */
function listenTransactions(){
  if(unsubTx)unsubTx();

  unsubTx=onSnapshot(
    query(
      collection(db,"customers",currentCustomerId,"transactions"),
      orderBy("createdAt","desc")
    ),
    async snap=>{
      history.innerHTML="";
      let balance=0;
      const txs=[];

      snap.forEach(d=>{
        txs.push({id:d.id,...d.data()});
        balance+=d.data().type==="baki"
          ? d.data().amount
          : -d.data().amount;
      });

      detailBalance.innerText=`Total Due: ${balance} Taka`;

      /* auto clear if zero */
      if(balance===0 && txs.length){
        for(const t of txs){
          await deleteDoc(doc(db,"customers",currentCustomerId,"transactions",t.id));
        }
        await updateDoc(doc(db,"customers",currentCustomerId),{balance:0});
        return;
      }

      txs.forEach(t=>{
        history.innerHTML+=`
          <tr>
            <td>${t.date}</td>
            <td class="${t.type}">${t.type==="baki"?"Due":"Payment"}</td>
            <td>${t.amount}</td>
            <td>${t.note||"-"}</td>
            <td class="tx-btn edit" onclick="editTx('${t.id}',${t.amount},'${t.type}','${t.note||""}')">‚úèÔ∏è</td>
            <td class="tx-btn delete" onclick="deleteTx('${t.id}')">üóëÔ∏è</td>
          </tr>
        `;
      });

      await updateDoc(doc(db,"customers",currentCustomerId),{balance});
    }
  );
}

/* ================= ADD / EDIT TX ================= */
detailForm.onsubmit=async e=>{
  e.preventDefault();

  const tx={
    amount:+amount.value,
    type:type.value,
    note:note.value,
    date:formatDate(),
    createdAt:Date.now()
  };

  const txCol=collection(db,"customers",currentCustomerId,"transactions");

  if(editingTxId){
    await updateDoc(doc(txCol,editingTxId),tx);
    editingTxId=null;
  }else{
    await addDoc(txCol,tx);
  }

  detailForm.reset();
};

/* ================= EDIT ================= */
window.editTx=(id,amt,t,n)=>{
  editingTxId=id;
  amount.value=amt;
  type.value=t;
  note.value=n;
};

/* ================= DELETE ================= */
window.deleteTx=async id=>{
  if(confirm("Delete transaction?")){
    await deleteDoc(doc(db,"customers",currentCustomerId,"transactions",id));
  }
};

/* ================= BACK ================= */
window.goBack=()=>{
  pageDetail.style.display="none";
  pageList.style.display="block";
  if(unsubTx)unsubTx();
};
</script>
</body>
</html>
