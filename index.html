<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Baki Khata Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF LIB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box;font-family:system-ui,Arial}
body{background:#0f172a;padding:10px}
.container{max-width:520px;margin:auto;background:#ffffff;padding:14px;border-radius:16px}

h1{text-align:center;font-size:22px;color:#0f172a}
h2,h3{text-align:center;font-size:16px}

input,select,button{
  width:100%;padding:9px;margin:5px 0;
  border-radius:8px;border:1px solid #cbd5f5;font-size:14px
}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
button:hover{opacity:.9}

.back-btn{width:30%;margin-bottom:8px}

#grandTotal,#detailBalance{
  background:#020617;color:#e5e7eb;
  padding:6px 0;width:50%;border-radius:20px;
  margin:10px auto;font-weight:500
}
#detailName{
  text-transform:capitalize;
  background:#16a34a;color:#fff;
  padding:6px 0;width:60%;
  border-radius:20px;
  margin:10px auto;font-weight:600
}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
th{background:#f1f5f9;font-weight:600}

/* ===== ROW COLORS BY DUE ===== */
.high-due{background:#FDE8E8; font-weight: 700; color: #B91C1C; border: #FCA5A5;}
.mid-due{background:#FEF3C7; font-weight: 600; color: #92400E; border: #FCD34D;}
.low-due{background:#ECFDF3; font-weight: 500; color: #065F46; border: #6EE7B7;}

.icon{cursor:pointer;font-size:16px}
.edit{color:#2563eb}
.delete{color:#dc2626}
.history{color:#0f766e}

/* ===== TRANSACTION ===== */
.baki{color:#dc2626;font-weight:600}
.payment{color:#16a34a;font-weight:600}
</style>
</head>

<body>
<div class="container">

<!-- ================= PAGE 1 ================= -->
<div id="page-list">
<h1>üìí Baki Khata</h1>

<form id="addCustomerForm">
<input id="customerName" placeholder="Customer Name" required>
<button>Add Customer</button>
</form>

<input id="search" placeholder="üîç Search Customer">

<h3 id="grandTotal">Total Due: 0 Taka</h3>

<table>
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Balance</th>
<th>Edit</th>
<th>Delete</th>
<th>History</th>
</tr>
</thead>
<tbody id="customerList"></tbody>
</table>
</div>

<!-- ================= PAGE 2 ================= -->
<div id="page-detail" style="display:none">
<button class="back-btn" onclick="goBack()">‚¨Ö Back</button>

<h2 id="detailName"></h2>
<h3 id="detailBalance"></h3>

<form id="detailForm">
<input type="number" id="amount" placeholder="Amount" required>

<select id="type">
  <option value="baki">Due</option>
  <option value="payment">Payment</option>
</select>

<input type="date" id="date">
<input id="note" placeholder="Note">
<button>Add</button>
</form>

<table id="txTable" style="display:none">
<thead>
<tr>
<th>Date</th>
<th>Type</th>
<th>Amount</th>
<th>Note</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, deleteDoc, updateDoc,
  onSnapshot, query, orderBy, serverTimestamp, getDocs
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig={
  apiKey:"AIzaSyDO5I_osPflsq1MrPOY7YJ46iDNJKWlQWE",
  authDomain:"baki-khata-e0941.firebaseapp.com",
  projectId:"baki-khata-e0941"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* ===== DOM ===== */
const customerList=document.getElementById("customerList");
const pageList=document.getElementById("page-list");
const pageDetail=document.getElementById("page-detail");
const detailName=document.getElementById("detailName");
const detailBalance=document.getElementById("detailBalance");
const history=document.getElementById("history");
const txTable=document.getElementById("txTable");
const grandTotal=document.getElementById("grandTotal");
const searchInput=document.getElementById("search");

let customers=[];
let currentCustomerId=null;
let editingTxId=null;
let unsubTx=null;

/* ===== UTILS ===== */
const todayDMY=()=>{
  const d=new Date();
  return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
};

/* ===== PAGE 1 REALTIME ===== */
onSnapshot(collection(db,"customers"),snap=>{
  customers=[];
  snap.forEach(d=>customers.push({id:d.id,...d.data()}));
  renderCustomers(searchInput.value);
});

/* ===== RENDER CUSTOMERS ===== */
function renderCustomers(filter=""){
  customerList.innerHTML="";
  let total=0, i=1;

  customers
    .filter(c=>c.name.toLowerCase().includes(filter.toLowerCase()))
    .sort((a,b)=>(b.balance||0)-(a.balance||0))
    .forEach(c=>{
      total+=c.balance||0;

      let cls="low-due";
      if(c.balance>=1000) cls="high-due";
      else if(c.balance>=500) cls="mid-due";

      customerList.innerHTML+=`
      <tr class="${cls}">
        <td>${i++}</td>
        <td onclick="openCustomer('${c.id}','${c.name}')" style="cursor:pointer">${c.name}</td>
        <td>${c.balance||0}</td>
        <td class="icon edit" onclick="editCustomer('${c.id}','${c.name}')">‚úèÔ∏è</td>
        <td class="icon delete" onclick="deleteCustomer('${c.id}')">üóëÔ∏è</td>
        <td class="icon history" onclick="downloadHistory('${c.id}','${c.name}')">üìÑ</td>
      </tr>`;
    });

  grandTotal.innerText=`Total Due: ${total} Taka`;
}
searchInput.oninput=()=>renderCustomers(searchInput.value);

/* ===== ADD CUSTOMER ===== */
addCustomerForm.onsubmit=async e=>{
  e.preventDefault();
  const name=customerName.value.trim();
  if(customers.some(c=>c.name.toLowerCase()===name.toLowerCase())){
    alert("Customer already exists");
    return;
  }
  await addDoc(collection(db,"customers"),{
    name,balance:0,createdAt:serverTimestamp()
  });
  addCustomerForm.reset();
};

/* ===== CUSTOMER ACTION ===== */
window.editCustomer=async(id,name)=>{
  const n=prompt("Edit name",name);
  if(n) await updateDoc(doc(db,"customers",id),{name:n});
};
window.deleteCustomer=async id=>{
  if(confirm("Delete customer?")){
    await deleteDoc(doc(db,"customers",id));
  }
};

/* ===== OPEN CUSTOMER ===== */
window.openCustomer=(id,name)=>{
  currentCustomerId=id;
  detailName.innerText=name;
  pageList.style.display="none";
  pageDetail.style.display="block";
  listenTx();
};

/* ===== TRANSACTIONS ===== */
function listenTx(){
  if(unsubTx)unsubTx();
  unsubTx=onSnapshot(
    query(collection(db,"customers",currentCustomerId,"transactions"),orderBy("createdAt","desc")),
    snap=>{
      history.innerHTML="";
      let balance=0;

      snap.forEach(d=>{
        const t=d.data();
        balance+=t.type==="baki"?t.amount:-t.amount;
        history.innerHTML+=`
        <tr>
          <td>${t.date}</td>
          <td class="${t.type}">${t.type==="baki"?"Due":"Payment"}</td>
          <td>${t.amount}</td>
          <td>${t.note||"-"}</td>
          <td onclick="editTx('${d.id}',${t.amount},'${t.type}','${t.note||""}')">‚úèÔ∏è</td>
          <td onclick="deleteTx('${d.id}')">üóëÔ∏è</td>
        </tr>`;
      });

      detailBalance.innerText=`Total Due: ${balance} Taka`;
      txTable.style.display = balance===0 ? "none" : "table";
      updateDoc(doc(db,"customers",currentCustomerId),{balance});
    }
  );
}

/* ===== ADD / EDIT TX ===== */
detailForm.onsubmit=async e=>{
  e.preventDefault();
  const tx={
    amount:+amount.value,
    type:type.value,
    note:note.value,
    date:date.value?date.value.split("-").reverse().join("-"):todayDMY(),
    createdAt:Date.now()
  };
  const col=collection(db,"customers",currentCustomerId,"transactions");
  if(editingTxId){
    await updateDoc(doc(col,editingTxId),tx);
    editingTxId=null;
  }else{
    await addDoc(col,tx);
  }
  detailForm.reset();
};

window.editTx=(id,a,t,n)=>{
  editingTxId=id;
  amount.value=a;
  type.value=t;
  note.value=n;
};
window.deleteTx=async id=>{
  if(confirm("Delete transaction?")){
    await deleteDoc(doc(db,"customers",currentCustomerId,"transactions",id));
  }
};

/* ===== PDF HISTORY DOWNLOAD ===== */
window.downloadHistory=async(id,name)=>{
  const snap=await getDocs(
    query(collection(db,"customers",id,"transactions"),orderBy("createdAt","asc"))
  );
  if(snap.empty){alert("No history");return;}

  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF();
  pdf.text(`Customer History: ${name}`,14,15);

  const rows=[];
  snap.forEach(d=>{
    const t=d.data();
    rows.push([t.date,t.type,t.amount,t.note||"-"]);
  });

  pdf.autoTable({
    head:[["Date","Type","Amount","Note"]],
    body:rows,
    startY:20
  });

  pdf.save(`${name}_history.pdf`);
};

/* ===== BACK ===== */
window.goBack=()=>{
  pageDetail.style.display="none";
  pageList.style.display="block";
  if(unsubTx)unsubTx();
};
</script>
</body>
</html>
